<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <!-- Theme initialization script (runs before body to prevent flash) -->
    <script>
        (function () {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = stored || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../styles/main.scss">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ¤–</text></svg>">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <!-- Sidebar Toggle (visible when sidebar is collapsed) -->
                <button class="btn btn-link sidebar-toggle" id="sidebar-toggle-btn" title="Show sidebar">
                    <i class="bi bi-layout-sidebar"></i>
                </button>
                <!-- New Chat Button (visible in header when sidebar is collapsed) -->
                <button class="btn btn-link header-new-chat d-none" id="header-new-chat-btn" title="New conversation">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <h1 class="app-title">
                    <i class="bi bi-robot"></i>
                    <span class="app-title-text" id="header-app-name">{{ app_name }}</span>
                </h1>
            </div>
            <div class="header-right">
                <!-- Theme Toggle -->
                <button class="btn btn-link theme-toggle d-none" id="theme-toggle" title="Toggle theme">
                    <i class="bi bi-sun-fill" id="theme-icon-light"></i>
                    <i class="bi bi-moon-fill d-none" id="theme-icon-dark"></i>
                </button>
                <!-- Admin Settings Button (shown for admin users only) -->
                <button class="btn btn-link admin-settings-btn d-none" id="admin-settings-btn"
                    title="Application Settings">
                    <i class="bi bi-gear"></i>
                </button>
                <!-- User Dropdown (shown when logged in) -->
                <div class="dropdown d-none" id="user-dropdown">
                    <button class="btn btn-link dropdown-toggle" type="button" id="user-dropdown-btn"
                        data-bs-toggle="dropdown" aria-expanded="false" title="User menu">
                        <i class="bi bi-person-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="user-dropdown-btn">
                        <li><span class="dropdown-item-text fw-medium" id="dropdown-user-name">User</span></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <button class="dropdown-item" id="logout-btn">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Login Button (shown when not logged in) -->
                <a href="/api/auth/login" id="login-btn" class="btn btn-primary btn-sm">
                    <i class="bi bi-box-arrow-in-right"></i>
                    <span class="login-text">Login</span>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <div class="chat-container">
                <!-- Sidebar Overlay (mobile) -->
                <div class="sidebar-overlay" id="sidebar-overlay"></div>

                <!-- Sidebar -->
                <aside class="chat-sidebar" id="chat-sidebar">
                    <div class="sidebar-header">
                        <h2>Conversations</h2>
                        <div class="sidebar-header-actions">
                            <button class="btn btn-outline-primary btn-sm" id="new-chat-btn" title="New conversation">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="collapse-sidebar-btn"
                                title="Collapse sidebar">
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                        </div>
                    </div>
                    <div class="conversation-list" id="conversation-list">
                        <!-- Conversations loaded dynamically -->
                    </div>
                    <div class="sidebar-footer" id="sidebar-footer">
                        <div class="footer-content">
                            <span class="app-tag" id="app-tag"></span>
                            <span class="copyright">Â© <span id="copyright-year"></span></span>
                            <a href="#" class="github-link d-none" id="github-link" target="_blank"
                                rel="noopener noreferrer" title="View on GitHub">
                                <i class="bi bi-github"></i>
                            </a>
                        </div>
                    </div>
                </aside>

                <!-- Chat Area -->
                <div class="chat-area">
                    <!-- Messages -->
                    <div class="messages-container" id="messages-container">
                        <div class="welcome-message" id="welcome-message">
                            <div class="welcome-icon">
                                <i class="bi bi-chat-dots"></i>
                            </div>
                            <h2 id="welcome-title">Welcome to {{ app_name }}</h2>
                            <p id="welcome-subtitle">Your AI assistant with access to powerful tools.</p>
                            <p class="text-muted login-prompt"><span>Login to start chatting.</span><i
                                    class="bi bi-arrow-right-circle"></i></p>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="input-area">
                        <form id="chat-form" class="chat-form">
                            <div class="input-group">
                                <textarea id="message-input" class="form-control" placeholder="Type your message..."
                                    rows="1" disabled></textarea>
                                <button type="submit" class="btn btn-primary send-btn" id="send-btn" disabled>
                                    <i class="bi bi-send"></i>
                                </button>
                                <button type="button" class="btn btn-danger cancel-btn d-none" id="cancel-btn"
                                    title="Cancel response">
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                            </div>
                        </form>
                        <div class="input-info">
                            <span class="status-indicator" id="status-indicator">
                                <i class="bi bi-circle-fill"></i>
                                <span class="status-text">Disconnected</span>
                                <span class="tool-executing d-none" id="tool-executing">
                                    <i class="bi bi-gear spin"></i>
                                    <span class="tool-name"></span>
                                </span>
                            </span>
                            <div class="input-info-right">
                                <div class="model-selector-container d-none" id="model-selector-container">
                                    <select class="form-select form-select-sm" id="model-selector"
                                        title="Select AI model">
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                                <button type="button" class="tools-indicator" id="tools-btn"
                                    title="View available tools">
                                    <i class="bi bi-tools"></i>
                                    <span class="tools-count">0</span>
                                </button>
                                <a href="#" class="health-link" id="health-link" title="Check service health">
                                    <i class="bi bi-heart-pulse"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Tools Modal -->
        <div class="modal fade" id="tools-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-tools"></i>
                            Available Tools
                        </h5>
                        <div class="modal-header-actions">
                            <button type="button" class="btn-icon" id="tools-refresh-btn" title="Refresh tools list">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                    <div class="modal-body" id="tools-list">
                        <!-- Tools loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Rename Conversation Modal -->
        <div class="modal fade" id="rename-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-pencil"></i>
                            Rename Conversation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="rename-input" class="form-label">Conversation title</label>
                            <input type="text" class="form-control" id="rename-input" placeholder="Enter new title">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="rename-confirm-btn">Rename</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="delete-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">
                            <i class="bi bi-trash"></i>
                            Delete Conversation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong id="delete-conversation-title"></strong>"?</p>
                        <p class="text-muted mb-0">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="delete-confirm-btn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Check Modal -->
        <div class="modal fade" id="health-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-heart-pulse"></i>
                            Service Health
                        </h5>
                        <div class="modal-header-actions">
                            <button type="button" class="btn-icon" id="health-refresh-btn"
                                title="Refresh health status">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                    <div class="modal-body" id="health-content">
                        <!-- Health status loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tool Details Modal -->
        <div class="modal fade" id="tool-details-modal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear-wide-connected"></i>
                            Tool Execution Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Tabs for Tool Call and Source Info -->
                        <ul class="nav nav-tabs" id="tool-details-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tool-call-tab" data-bs-toggle="tab"
                                    data-bs-target="#tool-call-content" type="button" role="tab"
                                    aria-controls="tool-call-content" aria-selected="true">
                                    <i class="bi bi-terminal me-1"></i>Tool Call
                                </button>
                            </li>
                            <li class="nav-item d-none" role="presentation" id="source-info-tab-item">
                                <button class="nav-link" id="source-info-tab" data-bs-toggle="tab"
                                    data-bs-target="#source-info-content" type="button" role="tab"
                                    aria-controls="source-info-content" aria-selected="false">
                                    <i class="bi bi-info-circle me-1"></i>Source Info
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content pt-3" id="tool-details-tab-content">
                            <div class="tab-pane fade show active" id="tool-call-content" role="tabpanel"
                                aria-labelledby="tool-call-tab">
                                <!-- Tool call details loaded dynamically -->
                            </div>
                            <div class="tab-pane fade" id="source-info-content" role="tabpanel"
                                aria-labelledby="source-info-tab">
                                <!-- Source info loaded lazily when tab is activated -->
                                <div class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted small">Loading source information...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversation Info Modal -->
        <div class="modal fade" id="conversation-info-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-info-circle"></i>
                            Conversation Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="conversation-info-content">
                        <!-- Conversation info loaded dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Conversation Modal -->
        <div class="modal fade" id="share-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-share"></i>
                            Share Conversation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="share-content">
                        <!-- Share content loaded dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Settings Modal -->
        <div class="modal fade" id="settings-modal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear me-2"></i>
                            Application Settings
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Settings Tabs -->
                        <ul class="nav nav-tabs" id="settings-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="llm-tab" data-bs-toggle="tab"
                                    data-bs-target="#llm-settings" type="button" role="tab">
                                    <i class="bi bi-cpu me-1"></i>LLM
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="agent-tab" data-bs-toggle="tab"
                                    data-bs-target="#agent-settings" type="button" role="tab">
                                    <i class="bi bi-robot me-1"></i>Agent
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ui-tab" data-bs-toggle="tab" data-bs-target="#ui-settings"
                                    type="button" role="tab">
                                    <i class="bi bi-window me-1"></i>UI
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content pt-3" id="settings-tab-content">
                            <!-- LLM Settings Tab -->
                            <div class="tab-pane fade show active" id="llm-settings" role="tabpanel">
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Ollama Configuration</h6>
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label class="form-label">Ollama URL</label>
                                            <input type="text" class="form-control" id="settings-ollama-url"
                                                placeholder="http://localhost:11434">
                                            <div class="form-text">URL of the Ollama server</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="settings-ollama-timeout"
                                                min="30" max="300" step="10">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Default Model</label>
                                            <select class="form-select" id="settings-ollama-model">
                                                <option value="">Loading models...</option>
                                            </select>
                                            <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                                id="refresh-models-btn">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Models
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Context Window</label>
                                            <input type="number" class="form-control" id="settings-ollama-num-ctx"
                                                min="512" max="32768" step="512">
                                            <div class="form-text">Max tokens in context</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Temperature</label>
                                            <input type="range" class="form-range" id="settings-ollama-temperature"
                                                min="0" max="2" step="0.1">
                                            <span class="form-text" id="temperature-value">0.7</span>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Top P</label>
                                            <input type="range" class="form-range" id="settings-ollama-top-p" min="0"
                                                max="1" step="0.05">
                                            <span class="form-text" id="top-p-value">0.9</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h6 class="text-muted mb-3">Model Selection</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox"
                                            id="settings-allow-model-selection">
                                        <label class="form-check-label" for="settings-allow-model-selection">
                                            Allow users to select model
                                        </label>
                                    </div>
                                    <label class="form-label">Available Models</label>
                                    <textarea class="form-control font-monospace" id="settings-available-models"
                                        rows="3"
                                        placeholder="model_id|Display Name|Description,model_id2|Name 2|Desc 2"></textarea>
                                    <div class="form-text">
                                        Format: model_id|Display Name|Description (comma-separated)
                                    </div>
                                </div>
                            </div>

                            <!-- Agent Settings Tab -->
                            <div class="tab-pane fade" id="agent-settings" role="tabpanel">
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Agent Behavior</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Agent Name</label>
                                            <input type="text" class="form-control" id="settings-agent-name"
                                                placeholder="assistant">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="settings-agent-timeout"
                                                min="30" max="600" step="30">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Iterations</label>
                                            <input type="number" class="form-control" id="settings-max-iterations"
                                                min="1" max="50">
                                            <div class="form-text">Max LLM calls per message</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Tool Calls</label>
                                            <input type="number" class="form-control" id="settings-max-tool-calls"
                                                min="1" max="20">
                                            <div class="form-text">Per iteration</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Retries</label>
                                            <input type="number" class="form-control" id="settings-max-retries" min="0"
                                                max="10">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Error Handling</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                    id="settings-stop-on-error">
                                                <label class="form-check-label" for="settings-stop-on-error">
                                                    Stop on tool error
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                    id="settings-retry-on-error">
                                                <label class="form-check-label" for="settings-retry-on-error">
                                                    Retry failed tool calls
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h6 class="text-muted mb-3">System Prompt</h6>
                                    <textarea class="form-control font-monospace" id="settings-system-prompt" rows="10"
                                        placeholder="Enter the system prompt that defines the agent's behavior..."></textarea>
                                    <div class="form-text">
                                        Defines the agent's persona and instructions. Leave empty to use default.
                                    </div>
                                </div>
                            </div>

                            <!-- UI Settings Tab -->
                            <div class="tab-pane fade" id="ui-settings" role="tabpanel">
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Welcome Message</h6>
                                    <textarea class="form-control" id="settings-welcome-message" rows="2"
                                        placeholder="Your AI assistant with access to powerful tools."></textarea>
                                    <div class="form-text">Displayed below the title on the chat page</div>
                                </div>
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Rate Limiting</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Requests per Minute</label>
                                            <input type="number" class="form-control" id="settings-rate-limit-rpm"
                                                min="1" max="100">
                                            <div class="form-text">Max requests per user per minute</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Concurrent Requests</label>
                                            <input type="number" class="form-control"
                                                id="settings-rate-limit-concurrent" min="1" max="10">
                                            <div class="form-text">Max concurrent streaming requests</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h6 class="text-muted mb-3">Application Metadata</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">App Tag</label>
                                            <input type="text" class="form-control" id="settings-app-tag"
                                                placeholder="v1.0.0">
                                            <div class="form-text">Version tag in sidebar footer</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Repository URL</label>
                                            <input type="text" class="form-control" id="settings-app-repo-url"
                                                placeholder="https://github.com/...">
                                            <div class="form-text">GitHub link (empty to hide)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-outline-danger" id="reset-settings-btn">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset to Defaults
                            </button>
                        </div>
                        <div>
                            <span class="text-muted small me-3" id="settings-status"></span>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="save-settings-btn">
                                <i class="bi bi-check-lg me-1"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container for notifications -->
        <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    </div>

    <script type="module" src="../scripts/main.js"></script>
</body>

</html>
