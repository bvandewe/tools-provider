<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <!-- Theme initialization script (runs before body to prevent flash) -->
    <script>
        (function () {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = stored || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../styles/main.scss">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ¤–</text></svg>">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <!-- Sidebar Toggle (visible when sidebar is collapsed) -->
                <button class="btn btn-link sidebar-toggle" id="sidebar-toggle-btn" title="Show sidebar">
                    <i class="bi bi-layout-sidebar"></i>
                </button>
                <!-- New Chat Button (visible in header when sidebar is collapsed) -->
                <button class="btn btn-link header-new-chat d-none" id="header-new-chat-btn" title="New conversation">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <h1 class="app-title">
                    <i class="bi bi-robot"></i>
                    <span class="app-title-text" id="header-app-name">{{ app_name }}</span>
                </h1>
                <!-- Theme Toggle (next to title, visible when logged in) -->
                <button class="btn btn-link theme-toggle d-none" id="theme-toggle" title="Toggle theme">
                    <i class="bi bi-sun-fill" id="theme-icon-light"></i>
                    <i class="bi bi-moon-fill d-none" id="theme-icon-dark"></i>
                </button>
            </div>
            <div class="header-right">
                <!-- User Dropdown (shown when logged in) -->
                <div class="dropdown d-none" id="user-dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="user-dropdown-btn"
                        data-bs-toggle="dropdown" aria-expanded="false" title="User menu">
                        <i class="bi bi-person-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="user-dropdown-btn">
                        <li><span class="dropdown-item-text fw-medium" id="dropdown-user-name">User</span></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <button class="dropdown-item" id="logout-btn">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Login Button (shown when not logged in) -->
                <a href="/api/auth/login" id="login-btn" class="btn btn-primary btn-sm">
                    <i class="bi bi-box-arrow-in-right"></i>
                    <span class="login-text">Login</span>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <div class="chat-container">
                <!-- Sidebar Overlay (mobile) -->
                <div class="sidebar-overlay" id="sidebar-overlay"></div>

                <!-- Sidebar -->
                <aside class="chat-sidebar" id="chat-sidebar">
                    <div class="sidebar-header">
                        <h2>Conversations</h2>
                        <div class="sidebar-header-actions">
                            <button class="btn btn-outline-primary btn-sm" id="new-chat-btn" title="New conversation">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="collapse-sidebar-btn"
                                title="Collapse sidebar">
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                        </div>
                    </div>
                    <div class="conversation-list" id="conversation-list">
                        <!-- Conversations loaded dynamically -->
                    </div>
                    <div class="sidebar-footer" id="sidebar-footer">
                        <div class="footer-content">
                            <span class="app-tag" id="app-tag"></span>
                            <span class="copyright">Â© <span id="copyright-year"></span></span>
                            <a href="#" class="github-link d-none" id="github-link" target="_blank"
                                rel="noopener noreferrer" title="View on GitHub">
                                <i class="bi bi-github"></i>
                            </a>
                        </div>
                    </div>
                </aside>

                <!-- Chat Area -->
                <div class="chat-area">
                    <!-- Messages -->
                    <div class="messages-container" id="messages-container">
                        <div class="welcome-message" id="welcome-message">
                            <div class="welcome-icon">
                                <i class="bi bi-chat-dots"></i>
                            </div>
                            <h2 id="welcome-title">Welcome to {{ app_name }}</h2>
                            <p id="welcome-subtitle">Your AI assistant with access to powerful tools.</p>
                            <p class="text-muted login-prompt"><span>Login to start chatting.</span><i
                                    class="bi bi-arrow-right-circle"></i></p>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="input-area">
                        <form id="chat-form" class="chat-form">
                            <div class="input-group">
                                <textarea id="message-input" class="form-control" placeholder="Type your message..."
                                    rows="1" disabled></textarea>
                                <button type="submit" class="btn btn-primary send-btn" id="send-btn" disabled>
                                    <i class="bi bi-send"></i>
                                </button>
                                <button type="button" class="btn btn-danger cancel-btn d-none" id="cancel-btn"
                                    title="Cancel response">
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                            </div>
                        </form>
                        <div class="input-info">
                            <span class="status-indicator" id="status-indicator">
                                <i class="bi bi-circle-fill"></i>
                                <span class="status-text">Disconnected</span>
                                <span class="tool-executing d-none" id="tool-executing">
                                    <i class="bi bi-gear spin"></i>
                                    <span class="tool-name"></span>
                                </span>
                            </span>
                            <div class="input-info-right">
                                <div class="model-selector-container d-none" id="model-selector-container">
                                    <select class="form-select form-select-sm" id="model-selector"
                                        title="Select AI model">
                                        <!-- Options populated dynamically -->
                                    </select>
                                </div>
                                <button type="button" class="tools-indicator" id="tools-btn"
                                    title="View available tools">
                                    <i class="bi bi-tools"></i>
                                    <span class="tools-count">0</span>
                                </button>
                                <a href="#" class="health-link" id="health-link" title="Check service health">
                                    <i class="bi bi-heart-pulse"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Tools Modal -->
        <div class="modal fade" id="tools-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-tools"></i>
                            Available Tools
                        </h5>
                        <div class="modal-header-actions">
                            <button type="button" class="btn-icon" id="tools-refresh-btn" title="Refresh tools list">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                    <div class="modal-body" id="tools-list">
                        <!-- Tools loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Rename Conversation Modal -->
        <div class="modal fade" id="rename-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-pencil"></i>
                            Rename Conversation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="rename-input" class="form-label">Conversation title</label>
                            <input type="text" class="form-control" id="rename-input" placeholder="Enter new title">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="rename-confirm-btn">Rename</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="delete-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">
                            <i class="bi bi-trash"></i>
                            Delete Conversation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete "<strong id="delete-conversation-title"></strong>"?</p>
                        <p class="text-muted mb-0">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="delete-confirm-btn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Check Modal -->
        <div class="modal fade" id="health-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-heart-pulse"></i>
                            Service Health
                        </h5>
                        <div class="modal-header-actions">
                            <button type="button" class="btn-icon" id="health-refresh-btn"
                                title="Refresh health status">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                    <div class="modal-body" id="health-content">
                        <!-- Health status loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tool Details Modal -->
        <div class="modal fade" id="tool-details-modal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-gear-wide-connected"></i>
                            Tool Execution Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Tabs for Tool Call and Source Info -->
                        <ul class="nav nav-tabs" id="tool-details-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tool-call-tab" data-bs-toggle="tab"
                                    data-bs-target="#tool-call-content" type="button" role="tab"
                                    aria-controls="tool-call-content" aria-selected="true">
                                    <i class="bi bi-terminal me-1"></i>Tool Call
                                </button>
                            </li>
                            <li class="nav-item d-none" role="presentation" id="source-info-tab-item">
                                <button class="nav-link" id="source-info-tab" data-bs-toggle="tab"
                                    data-bs-target="#source-info-content" type="button" role="tab"
                                    aria-controls="source-info-content" aria-selected="false">
                                    <i class="bi bi-info-circle me-1"></i>Source Info
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content pt-3" id="tool-details-tab-content">
                            <div class="tab-pane fade show active" id="tool-call-content" role="tabpanel"
                                aria-labelledby="tool-call-tab">
                                <!-- Tool call details loaded dynamically -->
                            </div>
                            <div class="tab-pane fade" id="source-info-content" role="tabpanel"
                                aria-labelledby="source-info-tab">
                                <!-- Source info loaded lazily when tab is activated -->
                                <div class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted small">Loading source information...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversation Info Modal -->
        <div class="modal fade" id="conversation-info-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-info-circle"></i>
                            Conversation Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="conversation-info-content">
                        <!-- Conversation info loaded dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Conversation Modal -->
        <div class="modal fade" id="share-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-share"></i>
                            Share Conversation
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="share-content">
                        <!-- Share content loaded dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container for notifications -->
        <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    </div>

    <script type="module" src="../scripts/main.js"></script>
</body>

</html>
